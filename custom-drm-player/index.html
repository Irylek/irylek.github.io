<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Custom DRM Player</title>
    
    <!-- Shaka Player -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.6/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shaka-player/dist/controls.min.css">
    
    <!-- Clappr Player -->
    <script src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #121212;
            color: white;
        }
        .container {
            width: 80%;
            max-width: 800px;
        }
        video, #player-container {
            width: 100%;
            height: auto;
        }
        .shaka-video-container {
            position: relative;
            max-width: 800px;
            margin: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="shaka-container" class="shaka-video-container">
            <video id="shaka-video" autoplay controls class="shaka-video"></video>
        </div>
        <div id="clappr-container" style="display:none;"></div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const base64Param = urlParams.get('a');
            if (!base64Param) {
                console.error('No DRM configuration provided in URL parameters.');
                return;
            }
            
            try {
                const params = JSON.parse(atob(base64Param));
                document.title = params.title || 'Shaka DRM Player';
                
                const video = document.getElementById('shaka-video');
                const shakaContainer = document.getElementById('shaka-container');
                const clapprContainer = document.getElementById('clappr-container');
                
                if (shaka.Player.isBrowserSupported()) {
                    const player = new shaka.ui.Overlay(new shaka.Player(video), shakaContainer, video);
                    player.getControls();
                    
                    if (params.drmType === 'clearkey' && params.clearKeys) {
                        let formattedKeys = {};
                        for (const key in params.clearKeys) {
                            formattedKeys[params.clearKeys[key].KID] = params.clearKeys[key].KEY;
                        }
                        player.getPlayer().configure({ drm: { clearKeys: formattedKeys } });
                    } else if (params.drmType === 'widevine' && params.licenseUrl) {
                        player.getPlayer().configure({ drm: { servers: { 'com.widevine.alpha': params.licenseUrl } } });
                    } else if (params.drmType === 'playready' && params.licenseUrl) {
                        player.getPlayer().configure({ drm: { servers: { 'com.microsoft.playready': params.licenseUrl } } });
                    }
                    
                    await player.getPlayer().load(params.url);
                    video.play();
                } else {
                    console.warn('Shaka Player not supported, switching to Clappr.');
                    shakaContainer.style.display = 'none';
                    clapprContainer.style.display = 'block';
                    
                    new Clappr.Player({
                        source: params.url,
                        parentId: '#clappr-container',
                        autoPlay: true,
                        width: '100%',
                        height: '100%'
                    });
                }
            } catch (error) {
                console.error('Error loading DRM configuration:', error);
            }
        });
    </script>
</body>
</html>
