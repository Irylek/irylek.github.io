<!doctype html>
<html lang="en">
<head>
    <title>DRM Player</title>
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
        crossorigin="anonymous"
    >
    <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.3.8/dist/shaka-player.ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.3.8/dist/shaka-player.compiled.min.js"></script>
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/shaka-player/dist/controls.min.css"
    />
    <style>
        body {
            background-color: #000;
            color: #fff;
        }
        #container {
            width: 100%;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }
        #settings {
            width: 480px;
            height: 100%;
            padding: 30px;
            position: absolute;
            top: 0;
            right: 0;
            background-color: #111;
        }
        .form-control {
            font-size: .875rem;
            background-color: #222;
            color: #fff;
            border: 1px solid #555;
        }
        #player {
            width: calc(100% - 480px);
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: black;
        }
        video {
            width: 100%;
            height: 100vh;
        }
        .btn-primary {
            background-color: #0d6efd !important;
            border-color: #0d6efd !important;
        }
    </style>
</head>
<body>

<div id="container">
    <div id="settings">
        <form id="player-form">

            <!-- Manifest -->
            <div class="mb-3">
                <label for="url" class="form-label">Manifest:</label>
                <input
                    type="text"
                    class="form-control"
                    id="url"
                    placeholder="https://example.com/manifest.mpd"
                >
            </div>

            <!-- DRM Type -->
            <div class="mb-3">
                <label for="drmType" class="form-label">Type:</label>
                <select id="drmType" class="form-control">
                    <option value="clearkey">ClearKey</option>
                    <option value="license">License URL</option>
                </select>
            </div>

            <!-- ClearKeys container -->
            <div class="mb-3" id="keysContainer">
                <label for="clearKeys" class="form-label">Keys:</label>
                <textarea
                    class="form-control"
                    id="clearKeys"
                    rows="8"
                    placeholder="00000000000000000000000000000000:00000000000000000000000000000000"
                ></textarea>
            </div>

            <!-- DRM Method (widevine/playready) -->
            <div class="mb-3" id="methodContainer" style="display: none;">
                <label for="drmMethod" class="form-label">Method:</label>
                <select id="drmMethod" class="form-control">
                    <!-- Nowa opcja, by nic nie było wybrane domyślnie -->
                    <option value="">Select a method</option>
                    <option value="widevine">Widevine</option>
                    <option value="playready">PlayReady</option>
                </select>
            </div>

            <!-- License URL -->
            <div class="mb-3" id="licenseUrlContainer" style="display: none;">
                <label for="licenseUrl" class="form-label">License URL:</label>
                <input
                    type="text"
                    class="form-control"
                    id="licenseUrl"
                    placeholder="https://example.com/drm/AcquireLicense"
                >
            </div>

            <!-- PLAY button -->
            <div class="mb-3 text-center">
                <input
                    type="submit"
                    class="btn btn-primary w-100 mb-2"
                    value="Play"
                    disabled
                    id="playButton"
                >
            </div>

            <!-- Wanna play a Test Stream? -->
            <div class="mb-3 text-center" style="display: none;" id="testStreamContainer">
                <button
                    type="button"
                    id="testStreamButton"
                    class="btn btn-secondary w-100 mb-2"
                >Wanna play a Test Stream? Click me!</button>
            </div>

            <!-- Go back to / -->
            <div class="mb-3 text-center">
                <a href="https://irylek.github.io/" class="btn btn-secondary w-100">
                    Go back to /
                </a>
            </div>
        </form>
    </div>

    <div
        data-shaka-player-container
        id="player"
        data-shaka-player-cast-receiver-id="1BA79154"
    >
        <video data-shaka-player id="video" autoplay crossorigin="anonymous"></video>
    </div>
</div>

<script>
    // Prosta konfiguracja do "pytania" przeglądarki, czy obsługuje Widevine i PlayReady.
    const widevineConfigs = [{
        initDataTypes: ['cenc'],
        videoCapabilities: [
            { contentType: 'video/mp4; codecs="avc1.42E01E"' }
        ],
        audioCapabilities: [
            { contentType: 'audio/mp4; codecs="mp4a.40.2"' }
        ]
    }];

    const playreadyConfigs = [{
        initDataTypes: ['cenc'],
        videoCapabilities: [
            { contentType: 'video/mp4; codecs="avc1.42E01E"' }
        ],
        audioCapabilities: [
            { contentType: 'audio/mp4; codecs="mp4a.40.2"' }
        ]
    }];

    // Referencje do inputów
    let drmTypeSelect, drmMethodSelect, urlInput, clearKeysText, licenseUrlInput, playButton;

    async function detectDRMSupport() {
        // Pobieramy elementy opcji z <select id="drmMethod">
        const widevineOption = drmMethodSelect.querySelector('option[value="widevine"]');
        const playreadyOption = drmMethodSelect.querySelector('option[value="playready"]');

        // Domyślnie
        let widevineText = 'Widevine';
        let playreadyText = 'PlayReady';

        // Widevine
        try {
            await navigator.requestMediaKeySystemAccess('com.widevine.alpha', widevineConfigs);
        } catch (err) {
            widevineText += ' (Your browser does not support that)';
            widevineOption.disabled = true;
        }

        // PlayReady
        try {
            await navigator.requestMediaKeySystemAccess('com.microsoft.playready', playreadyConfigs);
        } catch (err) {
            playreadyText += ' (Your browser does not support that)';
            playreadyOption.disabled = true;
        }

        widevineOption.textContent = widevineText;
        playreadyOption.textContent = playreadyText;
    }

    /**
     * Walidacja wypełnienia pól:
     * - dla ClearKey:  url i clearKeys
     * - dla License:   drmMethod != "", url != "", licenseUrl != ""
     */
    function validateInputs() {
        const drmType = drmTypeSelect.value.trim();
        const urlVal = urlInput.value.trim();
        const clearKeysVal = clearKeysText.value.trim();
        const drmMethodVal = drmMethodSelect.value.trim();
        const licenseUrlVal = licenseUrlInput.value.trim();

        let isValid = false;

        if (drmType === 'clearkey') {
            // Wymagane: url i clearKeys
            isValid = (urlVal !== '' && clearKeysVal !== '');
        } else {
            // 'license' => Wymagane: method != "", url != "", licenseUrl != ""
            // plus sprawdzamy, czy nie wybrano opcji disabled
            // (np. widevine jest disabled przy braku wsparcia)
            const selectedOption = drmMethodSelect.querySelector('option:checked');
            const isOptionDisabled = selectedOption ? selectedOption.disabled : false;

            isValid = (
                drmMethodVal !== '' &&
                !isOptionDisabled &&
                urlVal !== '' &&
                licenseUrlVal !== ''
            );
        }

        playButton.disabled = !isValid;
    }

    function handleDrmTypeChange() {
        const drmType = drmTypeSelect.value;
        const keysContainer = document.getElementById('keysContainer');
        const methodContainer = document.getElementById('methodContainer');
        const licenseUrlContainer = document.getElementById('licenseUrlContainer');
        const testStreamContainer = document.getElementById('testStreamContainer');

        if (drmType === 'clearkey') {
            keysContainer.style.display = 'block';
            methodContainer.style.display = 'none';
            licenseUrlContainer.style.display = 'none';
            testStreamContainer.style.display = 'none';

            // Gdy przełączamy się z license na clearkey, zeruj method:
            drmMethodSelect.value = '';
            licenseUrlInput.value = '';

        } else {
            keysContainer.style.display = 'none';
            methodContainer.style.display = 'block';
            licenseUrlContainer.style.display = 'block';
            testStreamContainer.style.display = 'block';
        }
        validateInputs();
    }

    function handleTestStream() {
        const drmMethod = drmMethodSelect.value;
        let manifestUrl = 'https://storage.googleapis.com/wvmedia/cenc/h264/tears/tears_uhd.mpd';
        let licenseUrl = '';

        if (drmMethod === 'widevine') {
            licenseUrl = 'https://proxy.staging.widevine.com/proxy';
        } else if (drmMethod === 'playready') {
            manifestUrl = 'https://test.playready.microsoft.com/media/profficialsite/tearsofsteel_4k.ism/manifest.mpd';
            licenseUrl = 'https://test.playready.microsoft.com/service/rightsmanager.asmx?cfg=(persist:false,sl:150)';
        }
        urlInput.value = manifestUrl;
        licenseUrlInput.value = licenseUrl;

        validateInputs();
    }

    async function initPlayer() {
        const video = document.getElementById('video');
        const ui = video['ui'];
        const controls = ui.getControls();
        const player = controls.getPlayer();

        window.player = player;
        window.ui = ui;

        const drmType = drmTypeSelect.value;
        const url = urlInput.value;

        // ClearKey
        if (drmType === 'clearkey') {
            const clearKeys = parseClearKeys(clearKeysText.value);
            player.configure({
                drm: {
                    clearKeys: clearKeys
                }
            });
        } else {
            // License
            const drmMethod = drmMethodSelect.value;
            const licenseUrl = licenseUrlInput.value;

            if (drmMethod === 'widevine') {
                player.configure({
                    drm: {
                        servers: {
                            'com.widevine.alpha': licenseUrl
                        }
                    }
                });
            } else if (drmMethod === 'playready') {
                player.configure({
                    drm: {
                        servers: {
                            'com.microsoft.playready': licenseUrl
                        }
                    }
                });
            }
        }

        await player.load(url);
        player.play();
    }

    function parseClearKeys(clearKeysStr) {
        const clearKeys = {};
        const keyPairs = clearKeysStr.trim().replace(/\n/g, ',').split(',');
        keyPairs.forEach(pair => {
            const [kid, key] = pair.split(':');
            if (kid && key) {
                clearKeys[kid.trim()] = key.trim();
            }
        });
        return clearKeys;
    }

    function handleFormSubmit(event) {
        event.preventDefault();

        // Dodatkowa kontrola – jeśli walidacja jest zła, nic nie robimy:
        if (playButton.disabled) {
            return;
        }

        const urlValue = urlInput.value;

        // Obsługa sytuacji, gdy URL ma w sobie klucz ClearKey
        if (
            urlValue.includes("?decryption_key=") ||
            urlValue.includes("&decryption_key=") ||
            urlValue.includes("@")
        ) {
            const separator = urlValue.includes("?decryption_key=")
                ? "?decryption_key="
                : (urlValue.includes("&decryption_key=")
                    ? "&decryption_key="
                    : "@");
            const parts = urlValue.split(separator);
            const url = parts[0];
            const clearKeys = parts[1];

            // Ustawiamy ClearKey automatycznie
            urlInput.value = url;
            drmTypeSelect.value = 'clearkey';
            handleDrmTypeChange(); // pokaże/ukryje odpowiednie pola
            clearKeysText.value = clearKeys;
        }

        initPlayer();
    }

    async function init() {
        // Zapamiętujemy referencje do kluczowych elementów
        drmTypeSelect = document.getElementById('drmType');
        drmMethodSelect = document.getElementById('drmMethod');
        urlInput = document.getElementById('url');
        clearKeysText = document.getElementById('clearKeys');
        licenseUrlInput = document.getElementById('licenseUrl');
        playButton = document.getElementById('playButton');

        // Detekcja DRM
        await detectDRMSupport();

        // Eventy formularza
        const form = document.getElementById('player-form');
        form.addEventListener('submit', handleFormSubmit);

        // Zmiana type (clearkey/license)
        drmTypeSelect.addEventListener('change', handleDrmTypeChange);

        // Pola, których wartości kontrolujemy w walidacji
        drmMethodSelect.addEventListener('change', validateInputs);
        urlInput.addEventListener('input', validateInputs);
        clearKeysText.addEventListener('input', validateInputs);
        licenseUrlInput.addEventListener('input', validateInputs);

        // Przycisk testowy
        const testStreamButton = document.getElementById('testStreamButton');
        testStreamButton.addEventListener('click', handleTestStream);

        // Gdy Shaka UI się załaduje:
        document.addEventListener('shaka-ui-loaded', initPlayer);

        // Na start sprawdzamy, czy możemy włączyć/wyłączyć przycisk Play
        validateInputs();
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
